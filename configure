#!/bin/sh

if ! which vim 1>/dev/null 2>&1 ; then
    echo Please install vim first, and then run it again.
    exit
fi

if ! which cscope 1>/dev/null 2>&1 ; then
    echo Please install cscope package, the vim pluting needs cscope package.
    exit
fi

if ! which ctags 1>/dev/null 2>&1 ; then
    echo Pleass install ctags package, the vim plugin needs ctags package.
    exit
fi

if [ $(vim --version | awk '/VIM - Vi IMproved/{print ($5>=7.4)}') -ne 1 ];then
    echo Please upgrade vim to 7.4
    exit
fi

if ! which git 1>/dev/null 2>&1 ; then
    echo Pleass install git package, the vim plugin needs git command to update Plugins from internat.
    exit
fi

if [ -f ~/.vimrc ]; then
    cp ~/.vimrc ~/.vimrc.bak
fi

if [ -f ~/.vimrc.plugins ]; then
    cp ~/.vimrc.plugins ~/.vimrc.plugins.bak
fi

ln -sf $(pwd)/vimrc ~/.vimrc
ln -sf $(pwd)/vimrc.plugins ~/.vimrc.plugins

BUNDLE_DIR=~/.vim/bundle
GITHUB_BASEURL=https://github.com
# make sure ~/.vim/bundle exist.
mkdir -p ${BUNDLE_DIR}

pushd ${BUNDLE_DIR} 1>/dev/null 2>&1
grep '^\s*Plugin ' ~/.vimrc.plugins | awk -F"'" '{print $2}' | while read vim_plugin
do
    plugin_dir=$(basename ${vim_plugin%'.git'})
    if [ -d ${plugin_dir}/.git ]; then
        pushd ${plugin_dir} 2>&1 1>/dev/null
        git pull -q
        popd 2>&1 1>/dev/null
    else
        if [ -d ${plugin_dir} ]; then
            mv ${plugin_dir} ${plugin_dir}.bak
        fi
        git clone ${GITHUB_BASEURL}/${vim_plugin}
    fi
done
popd 1>/dev/null 2>&1
